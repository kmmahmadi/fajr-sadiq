import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:syncfusion_flutter_pdfviewer/pdfviewer.dart';
import '../../../state/app_state.dart';
import '../../../logic/kfgqpc_search.dart';

class TabMushaf extends StatefulWidget {
  const TabMushaf({super.key});

  @override
  State<TabMushaf> createState() => _TabMushafState();
}

class _TabMushafState extends State<TabMushaf> {
  final PdfViewerController _pdf = PdfViewerController();
  AyahCounter? counter;

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) async {
      final st = context.read<AppState>();
      _pdf.jumpToPage(st.lastPage);
      counter = await KfgqpcSearch.counterForPage(st.lastPage);
      setState(() {});
    });
  }

  @override
  Widget build(BuildContext context) {
    final st = context.watch<AppState>();

    final text = counter == null
        ? ''
        : 'ص ${st.lastPage} | ج ${counter!.jozz} | ${counter!.pos}/${counter!.total} | باقي ${counter!.remain}';

    return Stack(
      children: [
        SfPdfViewer.asset(
          'assets/mushaf/mushaf.pdf',
          controller: _pdf,
          onPageChanged: (d) async {
            await st.setLastPage(d.newPageNumber);
            counter = await KfgqpcSearch.counterForPage(d.newPageNumber);
            setState(() {});
          },
        ),
        if (st.hudEnabled)
          Positioned(
            top: 0,
            left: 0,
            right: 0,
            child: SafeArea(
              child: Container(
                color: Colors.black.withOpacity(.08),
                padding: const EdgeInsets.all(4),
                child: Text(
                  text,
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(fontSize: 10, fontWeight: FontWeight.bold),
                ),
              ),
            ),
          ),
      ],
    );
  }
}